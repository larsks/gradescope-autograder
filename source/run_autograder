#!/usr/bin/env bash

# WORKDIR=/autograder

# EMAIL is for unique identifier for the student so then we can handle multiple requests
# at once by creating a new directory for each student submission
EMAIL=$(grep -o '"email":\s*"[^"]*' submission_metadata.json | sed 's/"email": "\(.*\)@.*/\1/')
cp /autograder/submission/calculator.py /autograder/source/calculator.py

cd /autograder/source

cp id_ed25519 ~/.ssh/
cp config ~/.ssh/

chmod 600 /root/.ssh/id_ed25519
ssh -o StrictHostKeyChecking=no bastion "exit" # need to do this since bastion is ProxyJump
scp -o StrictHostKeyChecking=no -r /autograder/ oed1:~/autograder_${EMAIL}
ssh oed1 "cd ~/autograder_${EMAIL}/source && ./real_run_autograder"
scp -r oed1:~/autograder_${EMAIL}/results/results.json /autograder/results/
scp -r oed1:~/autograder_${EMAIL}/submission_metadata.json /autograder/
ssh -o StrictHostKeyChecking=no oed1 "rm -rf ~/autograder_${EMAIL}"
